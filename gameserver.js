/*
 *
 *	Jelda game server
 *
 */

////////////////////////////////////////////////////////////
// Required includes
////////////////////////////////////////////////////////////
var express = require('express'),
	app = express(),
	server = require('http').createServer(app),
	io = require('socket.io').listen(server);

////////////////////////////////////////////////////////////
// Static file routing
////////////////////////////////////////////////////////////
app.get('/', function(req, res) {
	res.sendfile(__dirname + '/client/default.html');
});

// If they're looking for static content, send that their way.
app.use(express.static(__dirname + '/client'));

////////////////////////////////////////////////////////////
// Configure socket.io for heroku
////////////////////////////////////////////////////////////
io.configure(function () { 
  io.set("transports", ["xhr-polling"]); 
  io.set("polling duration", 10); 
});

////////////////////////////////////////////////////////////
// Login code
////////////////////////////////////////////////////////////
app.get('/login/:token?', function(req, res) {

	// Debuggery
	console.log('requested player state');

	// Send the player state!
	res.send({
		PlayerInfo: {
			// Should be an initialized PlayerEntity at some point.
			Name: req.param('token'),
			Token: req.param('token')
		},
		LocationInfo: {
			LocationId: 'home'
		}
	});

});

////////////////////////////////////////////////////////////
// Map server connection logic
////////////////////////////////////////////////////////////
var world = io.on('connection', function(socket) {

	////////////////////////////////////////////////////////////
	// Handle attempts to login to a map.
	////////////////////////////////////////////////////////////
	socket.on('connect', function(data) {

		////////////////////////////////////////////////////////////
		// Respond with map state so we can sync map states
		////////////////////////////////////////////////////////////
		socket.emit('mapstate', {
			Entities: [
				{
					EntityId: '1234',
					EntityType: 'playerEntity',
					EntityState: {
						X: 50,
						Y: 50,
						DisplayName: data.token
					}
				}
			]
		});

	});

});

////////////////////////////////////////////////////////////
// Configure the port
////////////////////////////////////////////////////////////
var port = process.env.PORT || 8000;

////////////////////////////////////////////////////////////
// Start the server
////////////////////////////////////////////////////////////
server.listen(port);